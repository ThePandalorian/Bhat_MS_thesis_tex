\epigraph{\justifying From so simple a beginning, endless forms most beautiful and wonderful have been, and are being, evolved}{Charles Darwin}

\section{Adaptive diversification}\label{AD}
The questions proposed at the end of the previous chapter are best addressed by a modeling framework called `adaptive diversification', where an initially monomorphic population evolves to become polymorphic due to (disruptive) frequency-dependent selection. The framework has been widely used in evolutionary ecology and evolutionary game theory, especially in the context of sympatric speciation \citep{dieckmann_origin_1999}. Models of adaptive diversification can be broadly classified into three classes of models which differ starkly in their approach and assumptions \citep{doebeli_adaptive_2011}. I introduce all three approaches below.

\subsection{The `classic' adaptive dynamics approach}
The classic approach to modelling adaptive diversification was first articulated in the late 90s by J.J. Metz's group \citep{geritz_evolutionarily_1998}. The crux of the approach relies on the observation that evolutionary stability (in the ESS sense of evolutionary game theory) and asymptotic convergence stability (in the sense of dynamical systems) need not always coincide.\\
More concretely, consider an infinitely large asexual population that is monomorphic for some quantitative trait such that every individual of the population has the trait value $x \in \mathcal{T} \subseteq \mathbb{R}^n$. We are interested in the dynamics of $x$ over evolutionary time. There is assumed to be a separation of timescales between ecology and evolution such that whenever we observe the population, it is at ecological equilibrium (This is equivalent to a strong-selection + weak-mutation setting). The evolutionary dynamics of the trait value in the population are modelled as following the equation:
\begin{equation}
\label{AD_canonical_eqn}
\frac{dx}{dt} = g(x) = B(x)\left(\nabla_y f(y;x) \bigg{|}_{y=x}\right)
\end{equation}
Here, $B(x)$ describes the mutational process of the trait and is intended to model mutational biases. For the sake of simplicity, I will assume that $B(x) = 1$ below, but the essential results are not greatly changed by more complicated forms. $f(y;x)$ is the \emph{invasion fitness} function, and describes the expected fitness of a mutant type $y$ appearing in a population that is monomorphic $x$-valued.%\footnote{In evolutionary game theory notation, this is exactly the incentive function $h_{x,y,0}$ that characterizes whether a strategy is an ESS. Recall that $h_{p,q,\epsilon} = \mathbb{E}[p;(1-\epsilon)\delta_p+\epsilon\delta_q] - \mathbb{E}[q;(1-\epsilon)\delta_p+\epsilon\delta_q]$ is the `incentive' of switching from strategy $q$ to strategy $p$ in a population where a fraction $\epsilon$ of the individuals are $q$-players and the rest are $p$-players. Here, the strategies are continuous and the incentive is in terms of fitness.}
$x$ is sometimes called the `resident' trait value. Thus, evolution is modelled as following the gradient $\nabla_y f(y;x)$ of the invasion fitness, a quantity sometimes called the selection gradient. \eqref{AD_canonical_eqn} can be interpreted to mean that at each time step, the population `samples' all local mutations, and if a mutant can invade this resident population, then the trait rapidly spreads in the population, and by the time we next `observe' it, the entire population has adopted this mutant trait. Equation \eqref{AD_canonical_eqn} is called the \emph{canonical equation of adaptive dynamics}. Fixed points for this equation, \textit{i.e} points $x^*$ for which $g(x^*)=0$, are called \emph{evolutionary singularities}. These singularities can be characterized by two different stability notions, as we will see below, and the difference between the two notions captures the important phenomenon of \textit{evolutionary branching}, which we will encounter shortly.

\definition{\emph{(Convergence stability)}}{ A singularity $x^*$ is said to be convergent stable (CS) if it is an asymptotically stable fixed point for equation \eqref{AD_canonical_eqn}.}

Thus, singularities which are convergence stable are local attractors, in the sense that nearby populations will evolve towards this state.

\definition{\emph{(Evolutionary stability)}}{ A singularity $x^*$ is said to be evolutionarily stable (ES) if it cannot be invaded by any nearby mutants.}
\\
\\
In the one dimensional case, evolutionary stability requires that the invasion fitness be such that no mutant can invade the population. Since $g(x^*) = \frac{\partial}{\partial y}f(y;x^*) = 0$ by definition at a singularity, the condition for evolutionary stability is controlled by the second derivative, and is given by:
\begin{equation}
\label{ESS_condition}
\frac{\partial^2}{\partial y^2} f(y;x) \bigg{|}_{y=x=x^*} < 0
\end{equation}
On the other hand, from elementary non-linear dynamics, we know that convergence stability requires $\frac{dg}{dx} < 0$, \textit{i.e}:
\begin{equation}
\label{CS_condition}
\frac{\partial^2}{\partial x \partial y} f(y;x) \bigg{|}_{y=x=x^*} + \frac{\partial^2}{\partial y^2} f(y;x) \bigg{|}_{y=x=x^*} < 0
\end{equation}
Note that neither \eqref{ESS_condition} nor \eqref{CS_condition} imply the other, and thus, we arrive at the following classification of evolutionary singularities:
\begin{center}
    \begin{tabularx}{0.4\textwidth}{ 
  | >{\centering\arraybackslash}X 
  | >{\centering\arraybackslash}X 
  | >{\centering\arraybackslash}X | }
        \hline
           & \textbf{ES} & \textbf{not ES} \\
        \hline
        \textbf{CS} &  \circled{A}  &  \circled{B} \\ 
        \hline
        \textbf{not CS} & \circled{C}  & \circled{D} \\
        \hline
    \end{tabularx}
\end{center}

Points which are not convergent stable are not of interest to us because populations can only attain such a state if they begin there. Thus, \circled{C} and \circled{D} can be ignored for our purposes.\footnote{Singularities of type \circled{C} are sometimes called `garden of Eden' points, since a population that begins at such a point will remain there and cannot be invaded by nearby mutants, but if a population does not begin there (or is somehow driven out by external forces), it can never find its way back to the singularity.}\\
Points of type \circled{A} are both evolutionarily stable and convergent stable. Such points represent `endpoints' for evolution, since populations are attracted to such points and also cannot evolve away from them since they cannot be invaded by any nearby mutants. Points of type \circled{B} are CS but not ES. Populations are attracted to such points, but once they have arrived, they are susceptible to invasion by nearby mutants. Let $x^*$ be such a point, and let $x_1 < x^* < x_2$ be two points in the immediate vicinity of $x^*$.
\begin{claim}{(Protected Polymorphism)}
Each of $x_1$ and $x_2$ can invade the other
\end{claim}
\begin{proof}
We can Taylor expand the invasion fitness function as
\begin{align*}
    f(x_1 ; x_2) &= \underbrace{f(x_2 ; x_2)}_{=0} + \underbrace{(x_1 - x_2)}_{< 0 }\underbrace{\frac{\partial f}{\partial x_1}(x_1 ; x_2)\bigg{|}_{x_1 = x_2}}_{=g(x_2)} + \frac{(x_1-x_2)^2}{2} \frac{\partial^2 f}{\partial x_1^2}(x_1 ; x_2)\bigg{|}_{x_1 = x_2}
\end{align*}
where we have neglected terms that are higher than second order. Since $x^*$ is convergent stable, $\frac{d g}{dx}\bigg{|}_{x=x^*} < 0$ and we therefore see that $g$ is a decreasing function of $x$ in the immediate vicinity of $x^*$. Thus, since $x_2 > x^*$, we must have $g(x_2) < g(x^*) = 0$, and we can conclude that the second term in the RHS must be positive. Lastly, since $x^*$ is evolutionarily unstable, we must have $\frac{\partial^2 f}{\partial x_1^2}(x_1 ; x^*)\bigg{|}_{x_1 = x^*} > 0$ by the stability criterion. Thus, assuming $f$ is smooth, for $x_2$ sufficiently close to $x^*$, it must be the case that $\frac{\partial^2 f}{\partial x_1^2}(x_1 ; x_2)\bigg{|}_{x_1 = x_2} > 0$. Thus, the third term of the RHS is also positive, meaning that $f(x_1 ; x_2) > 0$, and that $x_1$ can thus invade $x_2$. An exactly analogous argument shows that $f(x_2 ; x_1) > 0$, thus completing the proof.
\end{proof}
Mutual invasibility of $x_1$ and $x_2$ results in a so-called `protected polymorphism' in which the population harbours some members with trait value $x_1$ and some members with trait value $x_2$. This can be shown in some cases to lead to further divergence where the polymorphisms grow further apart in trait space while both being maintained in the population. Thus, the population appears to have `branched' from a monomorphic state to a dimorphic state in trait space. Due to this reason, points of type \circled{B} are called \emph{branching points}, and the population is said to have undergone \emph{evolutionary branching} once it has gone from a monomorphism to a dimorphism. Note that once a population has branched, equation \eqref{AD_canonical_eqn} no longer describes the population, since it is no longer monomorphic - We instead need a system of \emph{two} equations, one for each morph.\\
In adaptive dynamics, the name of the game is thus formulating reasonable guesses for $B(x)$ and $f(y;x)$. For example, one common choice for modelling asexual resource competition is $B(x) \equiv 1$ and the invasion fitness function:
\begin{equation}
\label{AD_cts_logistic_invasion_fitness}
f(y:x) = 1 - \frac{\alpha(x,y)K(x)}{K(y)}
\end{equation}
where $\alpha(x,y)$ is called the \emph{competition kernel} and $K(x)$ is called the \emph{carrying capacity function} (formulated in analogy with Lotka-Volterra competition or the logistic equation). Invasion fitnesses are sometimes derived from more mechanistic processes (such as explicitly formulating birth/death functions), but the conceptual idea is the same regardless of how complicated these functions may be, and evolutionary branching easily arises in a very wide range of ecological scenarios as long as the frequency-dependence of the selective force is strong enough \citep{doebeli_evolutionary_2000,doebeli_adaptive_2011}.

\subsection{The PDE approach}

A slightly more general approach to adaptive diversification is to relax the assumption of separation of timescales while keeping the assumption of infinite population size. In this case, we instead wish to formulate an equation for the distribution $\phi(u)$ of trait values in $\mathcal{T}$. We thus seek PDEs of the form:
\begin{equation*}
    \frac{\partial \phi(u)}{\partial t} = F(u,\phi(u),t)
\end{equation*}
In PDE models, diversification shows up as patterns (in the Turing sense), and the existence of a polymorphism corresponds to a multimodal solution for $\phi(x)$. The functional form of $F$ is often formulated through biological principles. For example, in analogy to the logistic equation, one could postulate the continuous version:
\begin{equation}
\label{cts_logistic}
\frac{\partial \phi(u)}{\partial t} = r\phi(u)\left(1 - \frac{\phi(u)}{K(u)}\int\limits_{\mathcal{T}}\alpha(u,v)\phi(v)dv\right)
\end{equation}
where $r$ is a growth rate, $K(u)$ gives the carrying capacity of the environment for individuals with phenotype $u$, and $\alpha(u,v)$ is a competition kernel which determines the effect of an individual with phenotype $v$ on the growth of an individual with phenotype $u$, and the integral thus gives a measure of the effective density experienced by individuals with phenotype $u$. $\alpha(u,v)$ is generally chosen such that strength of competition decreases with phenotypic distance (for example, $\alpha(u,v) = \exp(|u-v|)$), in analogy with niche partitioning. Note that this is an integrodifferential equation, and as such, is usually not easy to solve for most functional forms of $\alpha(u,v)$. We thus need to resort to numerical methods to solve such equations. \\
PDE models can also incorporate space more easily than the classic adaptive dynamics approach. For example, Doebeli \textit{et al.} propose a spatial model of resource competition in which we track the density $\phi(x,u)$ of $u$-phenotype individuals at the location $x$ given by the PDE:
\begin{equation}
\begin{split}
\label{spatial_PDE}
\frac{\partial \phi(x,u)}{\partial t} = r\left(\int\limits_{\mathcal{T}}B(v)\phi(x,v)dv - \frac{\phi(x,u)}{K(x,u)}\int\limits_{\mathcal{S}}\int\limits_{\mathcal{T}}\alpha_p(u,v)\alpha_s(x,y)\phi(y,v)dvdy\right) \\ +m\left(\int\limits_{\mathcal{S}}D(x,y)\phi(y,u)dy - \phi(x,u)\right)
\end{split}
\end{equation}
where $B(v)$ is a birth kernel that specifies births and mutations, $K(x,u)$ is a carrying capacity function that varies with both phenotype and geographic location, $\alpha_p(u,v)$ describes how strength of competition varies with phenotypic distance, $\alpha_s(x,y)$ describes how strength of competition varies with spatial (geographic) distance, $m$ is a migration rate, and $D(x,y)$ is a dispersion kernel that describes the probability that an individual at location $y$ will migrate into location $x$.\\
PDE models sacrifice interpretability for increased generality. While these models can include space as well as incorporate polymorphic populations more easily, the equations themselves generally have to be solved numerically, and it is more difficult to gain understanding as to why a certain behavior is observed. Nevertheless, mathematically sophisticated techniques have shown that multimodality remains a robust phenomenon for a very wide class of PDE models \citep{elmhirst_pod_2008,doebeli_adaptive_2011}.

\subsection{Stochastic individual-based models}

The most general approach to modelling adaptive diversification is through individual-based models. In such models, birth rates, death rates, and interaction rules are specified for each individual, and system-level properties are observed by letting the system change according to these rules. These models can be shown to be more general, biologically explicit versions of both PDE models and adaptive dynamics models, as will be discussed in section \ref{dem_stoch}.

\subsection{An example of a prediction of adaptive diversification}

Consider the continuous version of the logistic equation given by the invasion fitness \eqref{AD_cts_logistic_invasion_fitness} in adaptive dynamics and the PDE \eqref{cts_logistic} for PDE models. Assume that we have $\alpha(u,v) = \exp{-(u-v)^2/(2\sigma^{2}_{\alpha})}$ and $K(u) = K_{0}\exp{-(u)^2/(2\sigma^{2}_{K})}$, \emph{i.e.} Gaussian carrying capacity and Gaussian competition kernel. Then, it is known that diversification fails (\emph{i.e.} the population remains monomorphic) if and only if:
\begin{equation}\label{AD_monomorphic_condn}
\sigma_K<\sigma_{\alpha}
\end{equation}.
One way that \ref{AD_monomorphic_condn} can be satisfied is if $\sigma_K$ is very small. Biologically, this means that the environment is such that only some very particular morphs are viable, and the limit where $\sigma_K = 0$ corresponds to a case where only a single morph is environmentally viable. Ecologists are well-acquainted with this notion, and refer to it as `habitat filtering', the phenomenon in which the habitat itself `selects' for certain phenotypes due to particular limiting abiotic factors.\\
\\
A second way to satisfy \ref{AD_monomorphic_condn} is if $\sigma_{\alpha}$ is very large. Biologically, this means that competition occurs across a wide range of phenotypes, and the limit where $\sigma_{\alpha} = \infty$ corresponds to frequency-independent competition. In other words, diversification can fail if competition cannot be alleviated through character displacement, \emph{i.e} selection is not disruptive (or has a very weak disruptive component). This could happen if, for example, the morphs are competing for a resource that has no alternatives and can only be acquired in a single way (Ex: Competition for sunlight in plants).

\section{Demographic stochasticity and stochastic models}\label{dem_stoch}

The probabilistic origins of adaptive diversification were first noted by Dieckmann and Law, who used a stochastic individual-based model in which ecological rules at the level of the individual led to the population evolving as a Markov chain in trait space in a `quasi-monomorphic' manner \citep{dieckmann_dynamical_1996}. This stochastic process was shown to yield the canonical equation of adaptive dynamics \eqref{AD_canonical_eqn} as a first order deterministic approximation, thus establishing a connection between stochastic individual-based rules (microscopic dynamics) and deterministic evolution via adaptive dynamics (macroscopic approximations). Champagnat \textit{et al.} have since used more sophisticated mathematical tools (measure-valued processes and their infinitesimal generators) to extend such models to include polymorphic populations, and have arrived at similar results \citep{champagnat_unifying_2006,champagnat_individual_2008}. These latter studies were able to show convergence of the expected paths of the stochastic process to both PDE models such as \eqref{cts_logistic} and the canonical equation \eqref{AD_canonical_eqn} based on the approximations used and the limits taken (large population size, weak mutation, separation of ecological and evolutionary timescales, etc), thus uniting the three modelling approaches introduced in section \ref{AD}. However, despite this explicit recognition of the probabilistic roots that unify adaptive diversification, the effects of demographic stochasticity on the process of diversification are relatively poorly studied.\\
\\
The effects of demographic stochasticity on evolutionary branching were first studied by Claessen \textit{et al.}, first for asexual populations \citep{claessen_delayed_2007} and later for sexual populations \citep{claessen_effect_2008}. Both studies used a two-patch resource competition models, and broadly first formulated deterministic adaptive dynamics for the system, and then used computational individual-based simulations in which the total population size is capped in order to study the effects of demographic stochasticity. Both studies found that smaller populations have longer waiting times to reach evolutionary branching, and found that below a critical threshold population size, populations did not branch and remained monomorphic. The sexual model \citep{claessen_effect_2008} was also empirically tested using data on resource polymorphism in populations of arctic charr fishes, where lake size acts as a proxy for the maximum allowed population size, and the authors indeed found that populations living in larger lakes tended to exhibit more polymorphism.\\

\myfig{0.8}{Media/2.1_dem_stoch_effects.png}{\textbf{Effect of population size on evolutionary branching}. Two different realizations of a stochastic individual-based model of resource competition in one dimension where individuals compete according to a continuous version of the logistic equation, written in Python. The infinite population limit of this equation is given by \eqref{cts_logistic} with $\sigma_{K} = 1.9, \sigma_{\alpha} = 0.7$. The PDE model (infinite population limit) predicts evolutionary branching for these parameter values. Each point represents an individual. The model on top has a population of around 1000 individuals and remains monomorphic. The model on the bottom has a population of around 10000 individuals and exhibits evolutionary branching, where an initially monomorphic population evolves to become dimorphic.}{fig_dem_stoch}

On the mathematical front, Wakano and Iwasa first provided analytical support for the phenomenon of delayed evolutionary branching in small monomorphic populations using a moment-based approach in a Wright-Fisher model where evolutionary branching was identified by an `explosion' in the variance of the trait distribution in the population \citep{wakano_evolutionary_2013}. These authors identified two different regimes of branching, which they call `deterministic branching' (meaning branching is guaranteed) and `stochastic branching' (meaning branches have a propensity to recombine soon after branching) based on population size and selection strength. They too found that polymorphism is more likely in larger populations, and that monomorphism is virtually guaranteed if the population size is small enough. Importantly, since their model was in a Wright-Fisher framework, the total population size was assumed to be fixed. Debarre and Otto have recently extended these results to cases in which population sizes are allowed to vary using a similar moment-based approach  \citep{debarre_evolutionary_2016}. These latter authors were able to further decompose the regimes of selection strength (and population size) identified by Wakano and Iwasa. Within Wakano and Iwasa's `stochastic branching' regime, Debarre and Otto identify a `no branching' regime, an `intermittent branching' regime, and a `branched' regime. The first and last of these are characterized by branching events that are either extremely infrequent or extremely frequent, leading to predictable dynamics. Only in the smaller intermediate range was branching `truly' unpredictable over biologically relevant timescales. In this intermediate regime, populations undergo repeated cycles of branching and collapse, and hence the number of polymorphisms in the population varies with time.\\

\section{Diversity in multi-dimensional trait space}\label{high_dim}
Organisms rarely (if ever) vary along a single independent phenotypic axis. However, adaptive dynamics in multi-dimensional trait space is not very easy to deal with due to mathematical technicalities that arise with identifying neccessary and sufficient criteria for evolutionary singularities to be branching points \citep{doebeli_adaptive_2011,leimar_multidimensional_2009}. As such, adaptive diversification in multi-dimensional trait spaces is usually studied through PDE models or individual-based models \citep{ispolatov_individual-based_2016}. As usual, all models discussed in this section operate in the (infinitely) large population limit. Surprisingly, while the question of saturating levels of diversity in adaptive diversification has not been extensively studied in either one dimensional models or explicit spatial models, it \textit{has} been examined in the context of the dependence on the dimensionality of the trait space. The motivation for these studies arises from the classic notions of competitive exclusion and limiting similarity, with position in trait space being thought of as analogous to the (Hutchinsonian) ecological niche.\\
Broadly, the results of these studies align with intuitive expectations: As the dimensionality of the trait space increases, expected diversity increases. For one-dimensional adaptive diversification, strong frequency-dependence is needed to ensure coexistence of multiple morphs/branches at equilibrium. Using the continuous logistic equation \eqref{cts_logistic} with Gaussian forms of $K(x)$ and $\alpha(x,y)$, Doebeli and Ispolatov have shown that as the dimensionality of the trait space increases, progressively weaker frequency dependence is sufficient to maintain multiple morphs at equilibrium \citep{doebeli_complexity_2010}. Furthermore, they have also shown that for a fixed level of frequency-dependence, the probability of having multiple morphs at equilibrium increases as the dimensionality of the trait space increases. Other authors have since arrived at broadly similar conclusions in more general settings \citep{debarre_multidimensional_2014,svardal_organismal_2014}. While these studies say that coexistence is \textit{easier} in higher dimensions, they do not comment on how many morphs are expected to coexist at equilibrium. This has only been addressed by a recent study \citep{doebeli_diversity_2017} which used adaptive dynamics for a continuous analogue of the Lotka-Volterra competition equations to attack the question. They find that all else being equal, the number of coexisting morphs should increase exponentially with the dimensionality of the trait space that the organisms compete in. These authors also repeat this analysis using PDE models (Equation \eqref{cts_logistic} in particular) and computational individual-based simulations in place of adaptive dynamics and claim to find the same broad results.

\section{The importance of being finite (and stochastic)}\label{goals}
The previous sections paint an intriguing picture of the state of adaptive diversification as an explanatory paradigm. Distinct modeling approaches (adaptive dynamics, PDE models, and stochastic IbMs) have been proposed to model adaptive diversification, and all predict that diversification is a robust phenomenon \citep{doebeli_adaptive_2011}. However, theory predicts an exponential increase in the number of coexisting eco-variants as the dimensionality of the trait space increases. Since organisms generally live in rather high-dimensional trait spaces, if we were to to by the theory, we would expect extremely high diversity of eco-variants to be the norm in nature. However, empirical literature (see section \ref{synthesis}) suggests that this is not the case. What, then, may explain this apparent disagreement of theory with the real world, and how may we remedy it?\\
I posit here that the culprit is the assumption of infinite population size. Indeed, we have seen that theoretical studies predict that when demographic stochasticity is taken into account, waiting time to branching increases, and below a threshold population size, the system fails to diversify. Though this is only an indirect measure of the expected number of coexisting eco-variants, it is nevertheless rather suggestive. Furthermore, empirical literature also suggests that population size can have important effects on the diversity of eco-variants that a population can harbour: In several species of lake fish known to harbour adaptive phenotypic polymorphisms, studies \citep{claessen_effect_2008,recknagel_crater_2014,recknagel_ecosystem_2017} show that population size is positively correlated lake size, and that larger lakes harbour more intraspecific polymorphism. However, since larger lakes also present more ecological opportunity in the form of resource niches, it is important to remember that population size is not the only factor at play here. Studies have also shown that higher population density is positively correlated with color polymorphism in African land snails \citep{owen_polymorphism_1963} and the occurrence of a discrete dimorphism in forcep size in European earwigs \citep{tomkins_population_2004}.\\
Intuitively, larger demographic stochasticity can lead to lower diversity due to the stochastic elimination of rare mutants regardless of their fitness advantage, in stark contrast to the `invasion implies fixation' paradigm of deterministic models such as adaptive dynamics. Larger demographic stochasticity also leaves populations with less `access' to mutations per unit time, which may explain why studies have consistently observed a larger wait time to diversification. Lastly, theories such as adaptive dynamics require the population to be exactly located at evolutionary singularities, whereas with finite, stochastic populations, we observe a spread around these singularities, further hindering diversification.\\
\\
In this thesis, I will directly use stochastic birth-death derived from first principles to investigate the expected number of distinct eco-variants that can be harboured in a system. In the process, we will develop a general organizational paradigm for developing stochastic individual-level population models from first principles, and show that many well-known models from population genetics arise as special cases in the infinite population size limit. Using certain approximation schemes, we will arrive at a tractable approximate process that describes how weak 
stochastic fluctuations drive populations away from deterministic expectations.

